<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Per Diem Exchange - Operator Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: "Inter", sans-serif;
            background: #0b0e11;
            color: #cbd5e1;
        }

        #header {
            background: #111722;
            padding: 12px 16px;
            border-bottom: 2px solid #1f2937;
            font-size: 20px;
        }

        #main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 12px;
        }

        .panel {
            background: #111722;
            border: 1px solid #1f2530;
            border-radius: 10px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.35);
        }

        .panel h2 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 22px;
            color: #9ca3af;
        }

        #live-price {
            font-size: 64px;
            font-weight: 700;
            color: #32ff87;
            text-shadow: 0 0 18px rgba(50, 255, 135, 0.4);
        }

        #live-price.down {
            color: #ff4e4e;
            text-shadow: 0 0 18px rgba(255, 78, 78, 0.4);
        }

        .control-group {
            display: flex;
            margin-bottom: 12px;
        }

        .control-group input {
            flex: 1;
            padding: 6px;
            border-radius: 6px;
            border: none;
            font-size: 16px;
            margin-right: 8px;
        }

        .control-group button {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            background: #32ff87;
            color: #0b0e11;
            font-weight: 600;
        }

        #freeze-btn {
            background: #c40000;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        #return-btn {
            background: #32ff87;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .event-btn {
            background: #32ff87;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div id="header">Per Diem Exchange - Operator Panel</div>

    <div id="main">

        <!-- Price Display -->
        <div class="panel" id="price-panel">
            <h2>Current Price</h2>
            <div id="live-price">10</div>
            <div id="change">+0.00 (0.00%)</div>
        </div>

        <!-- Controls -->
        <div class="panel" id="controls">
            <h2>Trading Controls</h2>

            <div class="control-group">
                <input type="number" id="buy-amount" placeholder="Silver Amount">
                <button id="buy-btn">Buy</button>
            </div>
            <div id="buy-preview" style="margin-bottom: 12px; font-size: 18px; color:#9ca3af;"></div>

            <div class="control-group">
                <input type="number" id="sell-amount" placeholder="PDM Amount">
                <button id="sell-btn">Sell</button>
            </div>
            <div id="sell-preview" style="margin-bottom: 12px; font-size: 18px; color:#9ca3af;"></div>

            <button id="freeze-btn">
                Freeze Market
            </button>

            <button id="return-btn">
                Allow Return
            </button>

            <span id="return-info"></span>

            <span id="event-info"></span>

            <button class="event⁻btn" id="coffee-btn">
                Fire 'Coffee'event
            </button>

            <button class="event⁻btn" id="grant-btn">
                Fire 'Grant'event
            </button>


        </div>

    </div>

    <script>
        let price = 10;

        const buyBtn = document.getElementById("buy-btn");
        const buyInput = document.getElementById("buy-amount");
        const buyPreview = document.getElementById("buy-preview");
        let buyPrice = 0;

        const sellBtn = document.getElementById("sell-btn");
        const sellInput = document.getElementById("sell-amount");
        const sellPreview = document.getElementById("sell-preview");
        let sellPrice = 0;

        const freezeBtn = document.getElementById("freeze-btn");
        const returnBtn = document.getElementById("return-btn");
        const returnInfo = document.getElementById("return-info");

        // Event Buttons
        const eventInfo = document.getElementById("event-info");
        const coffeeBtn = document.getElementById("coffee-btn");
        const grantBtn = document.getElementById("grant-btn");

        const socket = new WebSocket("ws://" + window.location.host + "/ws");

        socket.onmessage = async (event) => {
            const msg = JSON.parse(event.data);
            if (msg.type === "engine")
                update(msg.engine);
        };

        socket.onopen = async (event) => {
        };

        /* ---------- Update Functions ---------- */

        function update(engine) {
            const times = engine.times;
            const prices = engine.prices;
            const frozen = engine.frozen;
            const allowReturn = engine.allow_return;
            const returning = engine.returning;
            const event = engine.event;

            updatePrice(prices);
            updateFrozenBtn(frozen);
            updateReturnBtn(allowReturn, returning);

            updateEventInfo(event);


            // comment these to disable dynamic price updates //
            // updateBuyPreview();
            // updateSellPreview();
        }

        function updatePrice(prices) {
            price = prices[prices.length - 1];
            if (prices.length > 1) {
                prevPrice = prices[prices.length - 2];
            } else {
                prevPrice = price;
            }

            const priceEl = document.getElementById("live-price");
            const changeEl = document.getElementById("change");
            const diff = price - prevPrice;
            const pct = (diff / prevPrice) * 100;

            priceEl.textContent = price.toFixed(2);
            changeEl.textContent = `${diff >= 0 ? "+" : ""}${diff.toFixed(2)} (${pct.toFixed(2)}%)`;

            if (diff >= 0) priceEl.classList.remove("down");
            else priceEl.classList.add("down");
        }

        function updateBuyPreview() {
            const silver = parseFloat(buyInput.value);
            if (!isNaN(silver) && silver > 0) {
                buyPrice = price;
                const pdm = silver * price;
                const pdfmInt = Math.floor(pdm);
                buyPreview.textContent = `${pdm.toFixed(4)} (${pdfmInt}) PDM`;
            } else {
                buyPreview.textContent = "";
            }
        }

        function updateSellPreview() {
            const pdm = parseFloat(sellInput.value);
            if (!isNaN(pdm) && pdm > 0) {
                sellPrice = price;
                const silver = pdm / price;
                const silverInt = Math.floor(silver);
                sellPreview.textContent = `${silver.toFixed(2)} (${silverInt}) Silver`;
            } else {
                sellPreview.textContent = "";
            }
        }

        function updateFrozenBtn(frozen) {
            freezeBtn.textContent = frozen ? "Unfreeze Market" : "Freeze Market";
            freezeBtn.style.backgroundColor = frozen ? "red" : "green";
        }

        function updateReturnBtn(allowReturn, returning) {
            returnBtn.textContent = allowReturn ? "Disallow Return" : "Allow Return";
            returnBtn.style.backgroundColor = allowReturn ? "green" : "red";
            if (allowReturn) {
                if (returning > 0)
                    returnInfo.textContent = `Returning up`;
                else if (returning < 0)
                    returnInfo.textContent = `Returning down`;
                else
                    returnInfo.textContent = `Not returning`;
            } else {
                returnInfo.textContent = "Not allowed to return";
            }
        }

        function updateEventInfo(event) {
            if (event.finished) {
                eventInfo.textContent = "No event";
            } else {
                name = event.name;
                tick = event.tick;
                dticks = event.dticks;
                maxMu = event.max_mu;
                priority = event.priority;

                eventInfo.textContent = `${name}: ${tick}/${dticks} ; max_mu=${maxMu} ; priority=${priority}`;
            }

        }

        /* ---------- Event Listeners ---------- */

        buyBtn.onclick = () => {
            const silver = parseFloat(buyInput.value);
            const pdm = silver * buyPrice;
            if (!isNaN(silver) && silver > 0) {
                socket.send(JSON.stringify({ "type": "exchange", "pdm": pdm, "displayPrice": buyPrice }));
            }
            buyInput.value = "";
            updateBuyPreview();
        };

        sellBtn.onclick = () => {
            const pdm = parseFloat(sellInput.value);
            if (!isNaN(pdm) && pdm > 0) {
                socket.send(JSON.stringify({ "type": "exchange", "pdm": -pdm, "displayPrice": sellPrice }));
            }
            sellInput.value = "";
            updateSellPreview();
        };

        buyInput.addEventListener("input", updateBuyPreview);
        sellInput.addEventListener("input", updateSellPreview);
        freezeBtn.addEventListener("click", () => {
            socket.send(JSON.stringify({ "type": "freeze" }));
        });
        returnBtn.addEventListener("click", () => {
            socket.send(JSON.stringify({ "type": "allow-return" }));
        });
        coffeeBtn.addEventListener("click", () => {
            socket.send(JSON.stringify({ "type": "event", "event": "coffee" }));
        });

        grantBtn.addEventListener("click", () => {
            socket.send(JSON.stringify({ "type": "event", "event": "grant" }));
        });

    </script>
</body>

</html>