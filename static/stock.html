<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Per Diem Exchange - Live Market</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        /* ========== CSS Variables ========== */
        :root {
            --font-ticker: 24px;
            --font-panel-title: 28px;
            --font-price: 80px;
            --font-change: 32px;
            --font-trade-log-header: 26px;
            --font-trade-entry: 22px;
            --font-frozen-label: 120px;

            /* Dark Theme */
            --bg-primary: #0b0e11;
            --bg-secondary: #111722;
            --border-color: #1f2530;
            --border-accent: #1f2937;
            --text-primary: #cbd5e1;
            --text-secondary: #9ca3af;
            --price-up: #32ff87;
            --price-down: #ff4e4e;
            --shadow-color: rgba(0, 0, 0, 0.35);
            /* CHANGE THIS SINCE THE LIGHT-THEME COLOR DOESNT WORK */
            /* --chart-grid: rgba(255, 255, 255, 0.3); */
            --chart-grid: rgba(0, 0, 0, 0.3);
        }

        [data-theme="light"] {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --border-color: #e5e7eb;
            --border-accent: #d1d5db;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --price-up: #059669;
            --price-down: #dc2626;
            --shadow-color: rgba(0, 0, 0, 0.35);
            --chart-grid: rgba(0, 0, 0, 0.3);
        }

        /* ========== Base Styles ========== */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }

        /* ========== Ticker ========== */
        #ticker {
            width: 100%;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-accent);
            color: var(--text-secondary);
            padding: 8px;
            font-size: var(--font-ticker);
            min-height: 48px;
            line-height: 1.5;
            white-space: nowrap;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        .ticker-inner {
            display: inline-block;
            animation: marquee 20s linear infinite;
            white-space: nowrap;
        }

        @keyframes marquee {
            0% {
                transform: translateX(100vw);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        /* ========== Layout Grid ========== */
        #main {
            flex: 1 1 auto;
            min-height: 0;
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 16px;
            padding: 16px;
        }

        @media (max-width: 1024px) {
            #main {
                grid-template-columns: 1fr;
            }
        }

        /* ========== Panel Styles ========== */
        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px var(--shadow-color);
        }

        .panel-title {
            font-size: var(--font-panel-title);
            font-weight: 700;
            color: var(--text-secondary);
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        /* ========== Price Panel ========== */
        #price-panel {
            position: relative;
        }

        .price-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .price-info {
            flex: 1;
        }

        #live-price {
            font-size: var(--font-price);
            font-weight: 700;
            color: var(--price-up);
            text-shadow: 0 0 20px currentColor;
            transition: color 0.3s, text-shadow 0.3s;
            line-height: 1;
            margin: 8px 0;
        }

        #live-price.down {
            color: var(--price-down);
        }

        #change {
            font-size: var(--font-change);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .logo-placeholder {
            height: 80px;
            opacity: 0.2;
            margin-left: 20px;
        }

        /* ========== Chart ========== */
        #chart {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 16px;
            padding: 8px;
        }

        /* ========== Trade Log ========== */
        .trade-log-header {
            font-size: var(--font-trade-log-header);
            font-weight: 600;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: var(--bg-primary);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trade-log-header .label {
            font-family: "JetBrains Mono", "Courier New", monospace;
            color: var(--price-up);
            font-weight: 700;
        }

        .trade-log-header .columns {
            font-family: "Inter", sans-serif;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        #trade-log {
            flex: 1;
            overflow-y: hidden;
            padding-right: 8px;
        }

        .depth-entry {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            font-size: var(--font-trade-entry);
            border-radius: 6px;
            margin-bottom: 4px;
            transition: background 0.2s;
        }

        .depth-entry:hover {
            background: var(--bg-primary);
        }

        .trade-time {
            font-family: "JetBrains Mono", "Courier New", monospace;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .trade-values {
            font-family: "Inter", sans-serif;
            font-weight: 700;
            color: var(--text-primary);
        }

        .depth-bid .trade-values {
            color: var(--price-up);
        }

        .depth-ask .trade-values {
            color: var(--price-down);
        }

        .buy-label {
            color: var(--price-up);
            font-weight: 700;
        }

        .sell-label {
            color: var(--price-down);
            font-weight: 700;
        }

        /* ========== Frozen Overlay ========== */
        #frozen-label {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: var(--font-frozen-label);
            color: rgba(220, 38, 38, 0.4);
            font-weight: 900;
            pointer-events: none;
            z-index: 1000;
            display: none;
            text-shadow: 0 0 40px rgba(220, 38, 38, 0.6);
            letter-spacing: 8px;
        }

        [data-theme="light"] #frozen-label {
            color: rgba(220, 38, 38, 0.5);
            text-shadow: 0 0 30px rgba(220, 38, 38, 0.4);
        }

        /* ========== Theme Toggle (Hidden) ========== */
        #theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            z-index: 999;
            transition: all 0.3s;
            opacity: 0.7;
        }

        #theme-toggle:hover {
            opacity: 1;
            border-color: var(--price-up);
            transform: translateY(-2px);
        }
    </style>
</head>

<body>
    <!-- Ticker -->
    <div id="ticker">
        <div class="ticker-inner" id="tickerText"></div>
    </div>

    <!-- Main Content Grid -->
    <div id="main">
        <!-- Price Panel -->
        <div class="panel" id="price-panel">
            <div class="price-header">
                <div class="price-info">
                    <div class="panel-title">PER DIEM (PDM)</div>
                    <div id="live-price">10.00</div>
                    <div id="change">+0.00 (0.00%)</div>
                </div>
                <img src="" class="logo-placeholder" alt="">
            </div>
            <canvas id="chart"></canvas>
        </div>

        <!-- Trade Log Panel -->
        <div class="panel">
            <div class="trade-log-header">
                <span class="label">TRADE LOG</span>
                <span class="columns">PDM @ PRICE</span>
            </div>
            <div id="trade-log"></div>
        </div>
    </div>

    <!-- Frozen Market Overlay -->
    <div id="frozen-label">FROZEN</div>

    <!-- Theme Toggle Button (optional, can be removed) -->
    <button id="theme-toggle">Toggle Theme</button>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // ========== Chart Configuration ==========
        const ctx = document.getElementById('chart').getContext('2d');

        function cssVar(name) {
            return getComputedStyle(document.documentElement)
                .getPropertyValue(name).trim();
        }


        const chartData = {
            datasets: [{
                label: 'PDM Price',
                data: [],
                backgroundColor: 'rgba(0, 0, 0, 0)',
                borderWidth: 3,
                pointRadius: 0,
                pointHoverRadius: 6,
                tension: 0.1,
                segment: {
                    borderColor: ctx => {
                        return ctx.p1.parsed.y >= ctx.p0.parsed.y
                            ? getComputedStyle(document.documentElement).getPropertyValue('--price-up').trim()
                            : getComputedStyle(document.documentElement).getPropertyValue('--price-down').trim();
                    }
                }
            }]
        };

        const chartConfig = {
            type: 'line',
            data: chartData,
            options: {
                // responsive: true,
                // maintainAspectRatio: false,
                animation: {
                    duration: 300,
                    easing: 'linear',
                    y: { duration: 0 }
                },
                plugins: {
                    legend: { display: false },
                    title: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(17, 23, 34, 0.95)',
                        titleColor: '#cbd5e1',
                        bodyColor: '#cbd5e1',
                        borderColor: '#1f2530',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: (context) => `Price: ${context.parsed.y.toFixed(2)}`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            // color: 'var(--chart-grid)',
                            color: cssVar('--chart-grid'),
                            lineWidth: 1
                        },
                        ticks: {
                            font: {
                                family: 'JetBrains Mono, monospace',
                                size: 14,
                                weight: '500'
                            },
                            // color: 'var(--text-secondary)',
                            color: cssVar('--text-secondary'),
                            maxTicksLimit: 15,
                            autoSkip: true
                        }
                    },
                    y: {
                        grid: {
                            // color: 'var(--chart-grid)',
                            color: cssVar('--chart-grid'),
                            lineWidth: 1
                        },
                        ticks: {
                            font: {
                                family: 'Inter, sans-serif',
                                size: 14,
                                weight: '500'
                            },
                            // color: 'var(--text-primary)',
                            color: cssVar('--text-secondary'),
                            callback: (value) => value.toFixed(2)
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        };

        const chart = new Chart(ctx, chartConfig);

        // ========== WebSocket Connection ==========
        const socket = new WebSocket("ws://" + window.location.host + "/ws");

        socket.onopen = () => {
            console.log("WebSocket connected");
            socket.send(JSON.stringify({ type: "refresh" }));
        };

        socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);

            if (msg.type === "engine") {
                update(msg.engine);
            }
            if (msg.type === "buy" || msg.type === "sell") {
                loadTradeLog();
            }
        };

        socket.onerror = (error) => {
            console.error("WebSocket error:", error);
        };

        // ========== Update Functions ==========
        function update(engine) {
            updatePrice(engine.prices);
            updateChart(engine.times, engine.prices);
            updateFrozen(engine.frozen);
            loadTradeLog();
        }

        function updatePrice(prices) {
            if (!prices || prices.length === 0) return;

            const price = prices[prices.length - 1];
            const prevPrice = prices.length > 1 ? prices[prices.length - 2] : price;

            const priceEl = document.getElementById("live-price");
            const changeEl = document.getElementById("change");
            const diff = price - prevPrice;
            const pct = prevPrice !== 0 ? (diff / prevPrice) * 100 : 0;

            priceEl.textContent = price.toFixed(2);
            changeEl.textContent = `${diff >= 0 ? "+" : ""}${diff.toFixed(2)} (${pct.toFixed(2)}%)`;

            priceEl.classList.toggle("down", diff < 0);
        }

        function updateChart(times, prices) {
            if (!times || !prices || times.length === 0) return;

            const labels = times.map(t => {
                const d = new Date(t * 1000);
                const hh = d.getHours().toString().padStart(2, '0');
                const mm = d.getMinutes().toString().padStart(2, '0');
                return `${hh}:${mm}`;
            });

            chart.data.labels = labels;
            chart.data.datasets[0].data = prices;
            chart.update('none'); // Update without animation for smoother real-time updates
        }

        function updateFrozen(frozen) {
            document.getElementById("frozen-label").style.display = frozen ? "block" : "none";
        }

        // ========== Trade Log ==========
        const tradeLog = document.getElementById("trade-log");
        const TRADE_LOG_FILE = "static/trade_log.txt";
        const MAX_TRADES = 18;

        async function loadTradeLog() {
            try {
                const response = await fetch(`${TRADE_LOG_FILE}?t=${Date.now()}`, {
                    cache: "no-store"
                });

                if (!response.ok) return;

                const text = await response.text();
                const lines = text.trim().split("\n").filter(line => line.trim());

                tradeLog.innerHTML = "";

                const recentLines = lines.slice(-MAX_TRADES);

                recentLines.forEach(line => {
                    const parts = line.trim().split(",");
                    if (parts.length < 3) return;

                    const [epochStr, pdmStr, priceStr] = parts;
                    const epoch = parseFloat(epochStr);
                    const pdm = parseFloat(pdmStr);
                    const price = parseFloat(priceStr);

                    if (!isNaN(epoch) && !isNaN(pdm) && !isNaN(price)) {
                        addTradeEntry(epoch, pdm, price);
                    }
                });
            } catch (error) {
                console.error("Error loading trade log:", error);
            }
        }

        function addTradeEntry(time, pdm, price) {
            const pdmInt = Math.floor(Math.abs(pdm));
            const entry = document.createElement("div");
            const isBuy = pdm > 0;

            entry.className = `depth-entry ${isBuy ? "depth-bid" : "depth-ask"}`;

            const date = new Date(time * 1000);
            const timeStr = date.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            const exchangeLabel = isBuy
                ? '<span class="buy-label">BUY</span>'
                : '<span class="sell-label">SELL</span>';

            entry.innerHTML = `
                <span class="trade-time">${timeStr} ${exchangeLabel}</span>
                <span class="trade-values">${pdmInt} @ ${price.toFixed(2)}</span>
            `;

            tradeLog.prepend(entry);
        }

        // ========== Ticker Messages ==========
        const tickerMessages = [
            "• REVENUE OUTLOOK: COMPANIES EXPECTED TO SELL THINGS IN EXCHANGE FOR MONEY •",
            "• BREAKING: CHART GOES UP, THEN DOWN, CONFIRMING LONG-HELD SUSPICIONS •",
            "• ECONOMIC FORECAST: FUTURE EXPECTED TO CONTINUE HAPPENING •",
            "• CRIME RATES DROP AFTER CRIME IS DEEMED ILLEGAL BY THE GOVERNMENT •",
            "• EXPERTS OPINION: WHEN LOSING MONEY, DOUBLE DOWN TO EARN IT BACK •",
            "• INVESTMENT RESEARCH: BUY LOW, SELL HIGH STILL CONSIDERED GOOD ADVICE •",
            "• EXPERTS ADVICE: 100% OF PEOPLE WHO SELL, MAKE MONEY •",
            "• ANALYSIS SHOWS CORRELATION BETWEEN THINGS HAPPENING AND PEOPLE REACTING •",
            "• EXPERTS DISCOVER THAT THERE IS A LOT OF MONEY IN THE WORLD •",
            "• BREAKING: DATA SCIENTISTS PREDICT MARKET WITH 91% (±95%) ACCURACY •",
            "• EXPERT ANALYSIS: TRADING WORKS 50% OF THE TIME, ALL THE TIME •",
            "• ECONOMIC THEORY: THE VALUE OF A SILVER REMAINS CONSISTENTLY AT ONE SILVER •",
            "• ANALYSTS CONCLUDE INVESTING MONEY IS THE BEST WAY TO ACQUIRE MORE MONEY •",
            "• BREAKING: LOCAL STOCK EXCHANGE FOUND TO BE FULL OF STOCKS •",
            "• EXPERTS CONCLUDE GRAPH GOING TO THE RIGHT, AS TIME CONTINUES •",
            "• BREAKING: THE SECRET TO WEALTH IS HAVING MORE MONEY THAN EVERYONE ELSE •",
            "• ECONOMIC THEORY: MONEY IS JUST PAPER THAT WE ALL AGREED IS IMPORTANT •",
            "• ANALYSIS: 100% OF THE TIME, THERE IS A 50% CHANCE PRICE GOES UP •",
            "• EXPERTS OPINION: EVERYONE BUY, SO I CAN SELL •",
            "• MARKET TREND: PRICES EXPECTED TO BE AN ELEMENT OF THE REAL NUMBERS •",
            "• ANALYSIS SHOWS AN INVESTMENT THAT DOUBLES IS WORTH MORE THAN ONE THAT HALVES •",
            "• EXPERTS CONCLUDE: PEOPLE ARE SURPRISED WHEN UNEXPECTED THINGS HAPPEN •"
        ];

        let tickerIndex = 0;
        const tickerElement = document.getElementById("tickerText");

        // Initialize with first message
        tickerElement.textContent = tickerMessages[tickerIndex];

        // Rotate messages on animation iteration
        tickerElement.addEventListener("animationiteration", () => {
            tickerIndex = (tickerIndex + 1) % tickerMessages.length;
            tickerElement.textContent = tickerMessages[tickerIndex];
        });

        // ========== Theme Toggle ==========
        const themeToggle = document.getElementById("theme-toggle");

        themeToggle.addEventListener("click", () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? '' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('market-theme', newTheme);

            // Update chart colors
            chart.update();
        });

        // Load saved theme
        const savedTheme = localStorage.getItem('market-theme');
        if (savedTheme === 'light') {
            document.documentElement.setAttribute('data-theme', 'light');
        }

        // Optional: Auto-load trade log on page load
        loadTradeLog();
    </script>
</body>

</html>